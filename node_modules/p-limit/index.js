'use strict';
<<<<<<< HEAD
=======
const pTry = require('p-try');

>>>>>>> a622a84fa9b65a4b43e8645addefe35ee1624fe7
module.exports = concurrency => {
	if (concurrency < 1) {
		throw new TypeError('Expected `concurrency` to be a number from 1 and up');
	}

	const queue = [];
	let activeCount = 0;

	const next = () => {
		activeCount--;

		if (queue.length > 0) {
			queue.shift()();
		}
	};

	return fn => new Promise((resolve, reject) => {
		const run = () => {
			activeCount++;

<<<<<<< HEAD
			fn().then(
=======
			pTry(() => fn()).then(
>>>>>>> a622a84fa9b65a4b43e8645addefe35ee1624fe7
				val => {
					resolve(val);
					next();
				},
				err => {
					reject(err);
					next();
				}
			);
		};

		if (activeCount < concurrency) {
			run();
		} else {
			queue.push(run);
		}
	});
};
