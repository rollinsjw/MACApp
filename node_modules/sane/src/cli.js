#!/usr/bin/env node
'use strict';

var sane = require('../');
var argv = require('minimist')(process.argv.slice(2));
var execshell = require('exec-sh');

<<<<<<< HEAD
if (argv._.length === 0) {
  var msg =
    'Usage: sane <command> [...directory] [--glob=<filePattern>] ' +
    '[--ignored=<filePattern>] [--poll] [--watchman] [--dot] ' +
    '[--wait=<seconds>]';
=======
if(argv._.length === 0) {
  var msg = 'Usage: sane <command> [...directory] [--glob=<filePattern>] ' +
            '[--poll] [--watchman] [--dot] [--wait=<seconds>]';
>>>>>>> a622a84fa9b65a4b43e8645addefe35ee1624fe7
  console.error(msg);
  process.exit();
}

var opts = {};
var command = argv._[0];
var dir = argv._[1] || process.cwd();
var waitTime = Number(argv.wait || argv.w);
var dot = argv.dot || argv.d;
var glob = argv.glob || argv.g;
<<<<<<< HEAD
var ignored = argv.ignored || argv.i;
var poll = argv.poll || argv.p;
var watchman = argv.watchman || argv.w;

if (dot) {
  opts.dot = true;
}
if (glob) {
  opts.glob = glob;
}
if (ignored) {
  opts.ignored = ignored;
}
if (poll) {
  opts.poll = true;
}
if (watchman) {
  opts.watchman = true;
}
=======
var poll = argv.poll || argv.p;
var watchman = argv.watchman || argv.w;

if (dot) { opts.dot = true; }
if (glob) { opts.glob = glob; }
if (poll) { opts.poll = true; }
if (watchman) { opts.watchman = true; }
>>>>>>> a622a84fa9b65a4b43e8645addefe35ee1624fe7

var wait = false;
var watcher = sane(dir, opts);

<<<<<<< HEAD
watcher.on('ready', function() {
=======
watcher.on('ready', function () {
>>>>>>> a622a84fa9b65a4b43e8645addefe35ee1624fe7
  console.log('Watching: ', dir + '/' + (opts.glob || ''));
  execshell(command);
});

<<<<<<< HEAD
watcher.on('change', function(filepath) {
  if (wait) {
    return;
  }
=======
watcher.on('change', function (filepath) {
  if (wait) { return; }
>>>>>>> a622a84fa9b65a4b43e8645addefe35ee1624fe7
  console.log('Change detected in:', filepath);
  execshell(command);

  if (waitTime > 0) {
    wait = true;
<<<<<<< HEAD
    setTimeout(function() {
=======
    setTimeout(function () {
>>>>>>> a622a84fa9b65a4b43e8645addefe35ee1624fe7
      wait = false;
    }, waitTime * 1000);
  }
});
