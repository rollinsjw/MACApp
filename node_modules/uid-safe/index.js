/*!
 * uid-safe
 * Copyright(c) 2014 Jonathan Ong
<<<<<<< HEAD
 * Copyright(c) 2015 Douglas Christopher Wilson
=======
 * Copyright(c) 2015-2017 Douglas Christopher Wilson
>>>>>>> a622a84fa9b65a4b43e8645addefe35ee1624fe7
 * MIT Licensed
 */

'use strict'

/**
 * Module dependencies.
 * @private
 */

<<<<<<< HEAD
var crypto = require('crypto')
var escape = require('base64-url').escape
=======
var randomBytes = require('random-bytes')

/**
 * Module variables.
 * @private
 */

var EQUAL_GLOBAL_REGEXP = /=/g
var PLUS_GLOBAL_REGEXP = /\+/g
var SLASH_GLOBAL_REGEXP = /\//g
>>>>>>> a622a84fa9b65a4b43e8645addefe35ee1624fe7

/**
 * Module exports.
 * @public
 */

module.exports = uid
module.exports.sync = uidSync

/**
 * Create a unique ID.
 *
 * @param {number} length
 * @param {function} [callback]
 * @return {Promise}
 * @public
 */

<<<<<<< HEAD
function uid(length, callback) {
=======
function uid (length, callback) {
>>>>>>> a622a84fa9b65a4b43e8645addefe35ee1624fe7
  // validate callback is a function, if provided
  if (callback !== undefined && typeof callback !== 'function') {
    throw new TypeError('argument callback must be a function')
  }

  // require the callback without promises
  if (!callback && !global.Promise) {
    throw new TypeError('argument callback is required')
  }

  if (callback) {
    // classic callback style
    return generateUid(length, callback)
  }

<<<<<<< HEAD
  return new Promise(function executor(resolve, reject) {
    generateUid(length, function onUid(err, str) {
=======
  return new Promise(function executor (resolve, reject) {
    generateUid(length, function onUid (err, str) {
>>>>>>> a622a84fa9b65a4b43e8645addefe35ee1624fe7
      if (err) return reject(err)
      resolve(str)
    })
  })
}

/**
 * Create a unique ID sync.
 *
 * @param {number} length
 * @return {string}
 * @public
 */

<<<<<<< HEAD
function uidSync(length) {
  try {
    return toString(crypto.randomBytes(length))
  } catch (e) {
    return toString(crypto.pseudoRandomBytes(length))
  }
=======
function uidSync (length) {
  return toString(randomBytes.sync(length))
>>>>>>> a622a84fa9b65a4b43e8645addefe35ee1624fe7
}

/**
 * Generate a unique ID string.
 *
 * @param {number} length
 * @param {function} callback
 * @private
 */

<<<<<<< HEAD
function generateUid(length, callback) {
=======
function generateUid (length, callback) {
>>>>>>> a622a84fa9b65a4b43e8645addefe35ee1624fe7
  randomBytes(length, function (err, buf) {
    if (err) return callback(err)
    callback(null, toString(buf))
  })
}

/**
<<<<<<< HEAD
 * Get some random bytes.
 *
 * @param {number} length
 * @param {function} callback
 * @return {Buffer}
 * @private
 */

function randomBytes(length, callback) {
  crypto.randomBytes(length, function (err, buf) {
    if (!err) return callback(null, buf)
    crypto.pseudoRandomBytes(length, function (err, buf) {
      if (err) return callback(err)
      callback(null, buf)
    })
  })
}

/**
=======
>>>>>>> a622a84fa9b65a4b43e8645addefe35ee1624fe7
 * Change a Buffer into a string.
 *
 * @param {Buffer} buf
 * @return {string}
 * @private
 */

<<<<<<< HEAD
function toString(buf) {
  return escape(buf.toString('base64'))
=======
function toString (buf) {
  return buf.toString('base64')
    .replace(PLUS_GLOBAL_REGEXP, '-')
    .replace(SLASH_GLOBAL_REGEXP, '_')
    .replace(EQUAL_GLOBAL_REGEXP, '')
>>>>>>> a622a84fa9b65a4b43e8645addefe35ee1624fe7
}
